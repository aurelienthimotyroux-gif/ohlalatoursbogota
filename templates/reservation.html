<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
  <meta charset="UTF-8" />
  <title>{{ _("R√©server votre visite") }} ‚Äî Oh La La Tours Bogot√°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ Meta SEO -->
  <meta name="description" content="{{ _('R√©servez votre visite guid√©e √† Bogot√° : Candelaria, Monserrate, Zipaquir√°, La Chorrera et finca caf√©. Guide francophone/anglais/espagnol.') }}">
  <meta name="keywords" content="r√©servation tour Bogot√°, r√©server visite guid√©e Bogot√°, tours priv√©s Bogot√°, Candelaria, Monserrate, Zipaquir√°, La Chorrera, Hacienda Coloma, guide francophone Bogot√°">

  <!-- ‚úÖ CMP / consentmanager (doit √™tre avant GA) -->
  <script type="text/javascript" data-cmp-ab="0"
          src="https://cdn.consentmanager.net/delivery/autoblocking/62cc8437f29ac.js"
          data-cmp-host="b.delivery.consentmanager.net"
          data-cmp-cdn="cdn.consentmanager.net"
          data-cmp-codesrc="16"></script>

  <!-- ‚úÖ Google Consent Mode -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('consent', 'default', {
      ad_storage: 'denied',
      analytics_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied',
      wait_for_update: 500
    });
  </script>

  <!-- ‚úÖ Google tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-92M6CENDXH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-92M6CENDXH', { anonymize_ip: true });
  </script>

  <!-- ‚úÖ Texte masqu√© accessible -->
  <style>
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1px,1px);white-space:nowrap;border:0}
  </style>

  <!-- ‚úÖ Styles AJOUT√âS pour le header fixe + logo -->
  <style>
    .site-header{
      position:fixed; top:0; left:0; right:0; z-index:70;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; gap:16px;
      background:transparent; transition:background .25s ease, box-shadow .25s ease;
    }
    .brand{display:inline-flex; align-items:center; gap:10px}
    .logo{height:44px; width:auto; display:block}
    @media (max-width:640px){ .logo{height:32px} }

    .main-nav{display:flex; align-items:center; gap:18px; font-weight:600}
    .main-nav a{text-decoration:none}
    .lang-switcher{display:flex; gap:8px; margin-left:8px}
    .lang-switcher a{font-size:20px; line-height:1; padding:4px 6px; border-radius:6px}

    /* Sur cette page (hero en fond) : liens & logo blancs au d√©part */
    .header-on-hero .main-nav a{color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .logo--dark{display:none}

    /* ‚úÖ Titre ajout√© */
    .site-title{
      font-size:1.35rem;
      font-weight:600;
      margin-left:8px;
      line-height:1.2;
    }
    .header-on-hero .site-title{ color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35); }
    .site-header.scrolled .site-title{ color:#0f172a; text-shadow:none; }

    /* Au scroll / fond clair */
    .site-header.scrolled{
      background: rgba(255,255,255,.86);
      backdrop-filter: saturate(180%) blur(8px);
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .site-header.scrolled .logo--light{display:none}
    .site-header.scrolled .logo--dark{display:block}
    .site-header.scrolled .main-nav a{color:#0f172a}
  </style>

  <!-- ‚úÖ Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='img/favicon/site.webmanifest') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon/favicon.ico') }}">
  <link rel="icon" href="/favicon.ico" sizes="any">
  <meta name="theme-color" content="#0b4654">
  <meta name="google-site-verification" content="4z28-XXEkdcB_VOcaGoy1bhgA-zj7xr6wSf76ZwZ4tQ" />

  <!-- ‚úÖ Canonical + hreflang -->
  <link rel="canonical" href="https://www.ohlalatoursbogota.com{{ request.path }}{% if get_locale()!='fr' %}?lang={{ get_locale() }}{% endif %}">
  <link rel="alternate" href="{{ url_for('reservation', lang='fr', _external=True) }}" hreflang="fr">
  <link rel="alternate" href="{{ url_for('reservation', lang='en', _external=True) }}" hreflang="en">
  <link rel="alternate" href="{{ url_for('reservation', lang='es', _external=True) }}" hreflang="es">
  <link rel="alternate" href="{{ url_for('reservation', lang='fr', _external=True) }}" hreflang="x-default">

  <!-- ‚úÖ Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.ohlalatoursbogota.com{{ request.path }}{% if get_locale()!='fr' %}?lang={{ get_locale() }}{% endif %}">
  <meta property="og:site_name" content="Oh La La Tours Bogot√°">
  <meta property="og:title" content="{{ _('R√©server votre visite ‚Äì Oh La La Tours Bogot√°') }}">
  <meta property="og:description" content="{{ _('R√©servez une visite guid√©e : Candelaria, Monserrate, Zipaquir√°, La Chorrera ou finca caf√©. Paiement PayPal, guide francophone/anglais/espagnol.') }}">
  <meta property="og:image" content="{{ url_for('static', filename='images/bg_reservation.jpg', _external=True) }}">
  <meta property="og:image:alt" content="{{ _('Panorama de Bogot√°, t√©l√©ph√©rique de Monserrate et rues coloniales de la Candelaria...') }}">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _('R√©server votre visite ‚Äì Oh La La Tours Bogot√°') }}">
  <meta name="twitter:description" content="{{ _('R√©servez une visite guid√©e...') }}">
  <meta name="twitter:image" content="{{ url_for('static', filename='images/bg_reservation.jpg', _external=True) }}">
  <meta name="twitter:image:alt" content="{{ _('Panorama de Bogot√°, t√©l√©ph√©rique de Monserrate et rues coloniales de la Candelaria...') }}">

  <!-- ‚úÖ CSS global -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- üì± intl-tel-input (drapeaux + indicatifs) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/css/intlTelInput.css" />
</head>
<body>

<header class="site-header header-on-hero">
  <div class="logo-container">
    <!-- Logo clair -->
    <img src="{{ url_for('static', filename='img/logo-light.png') }}" alt="Oh La La Tours Bogot√°" class="logo logo--light">
    <!-- Logo fonc√© -->
    <img src="{{ url_for('static', filename='img/logo-dark.png') }}" alt="Oh La La Tours Bogot√°" class="logo logo--dark">
    <!-- ‚úÖ Titre ajout√© -->
    <span class="site-title">Oh La La Tours Bogot√°</span>
  </div>

  <nav class="main-nav" aria-label="{{ _('Navigation principale') }}">
    <a href="{{ url_for('index', lang=get_locale()) }}">{{ _("Accueil") }}</a>
    <a href="{{ url_for('tours', lang=get_locale()) }}">{{ _("Nos tours") }}</a>
    <a href="{{ url_for('transport', lang=get_locale()) }}">{{ _("Service de Transport") }}</a>
    <a href="{{ url_for('reservation', lang=get_locale()) }}">{{ _("R√©servation") }}</a>
    <div class="lang-switcher" aria-label="{{ _('Changer de langue') }}">
      <a href="{{ lang_url('fr') }}" lang="fr" aria-label="Fran√ßais">üá´üá∑<span class="sr-only">Fran√ßais</span></a>
      <a href="{{ lang_url('en') }}" lang="en" aria-label="English">üá∫üá∏<span class="sr-only">English</span></a>
      <a href="{{ lang_url('es') }}" lang="es" aria-label="Espa√±ol">üá™üá∏<span class="sr-only">Espa√±ol</span></a>
    </div>
  </nav>
</header>

<!-- Bandeau -->
<header class="hero background-half"
        style="background-image: url('{{ url_for('static', filename='images/bg_reservation.jpg') }}');">
  <h1 class="hero-title">
    {{ _("R√©server votre visite") }}{% if tour %} : {{ _(tour.capitalize()) }}{% endif %}
  </h1>
</header>

<!-- Fil d‚ÄôAriane -->
<nav aria-label="{{ _('Fil d‚ÄôAriane') }}" style="max-width:1000px;margin:10px auto;padding:0 20px;font-size:.95rem;">
  <a href="{{ url_for('index', lang=get_locale()) }}">{{ _('Accueil') }}</a> ‚Ä∫
  <a href="{{ url_for('tours', lang=get_locale()) }}">{{ _('Nos tours') }}</a> ‚Ä∫
  <span aria-current="page">{{ _('R√©servation') }}</span>
</nav>

<!-- Formulaire -->
<main>
  <section class="reservation-container">

    <!-- üîî Messages flash visibles en haut de la section -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages" style="max-width:1000px;margin:16px auto;padding:12px 14px;border-radius:10px;background:#e6ffed;color:#065f46;border:1px solid #a7f3d0;">
          {% for category, message in messages %}
            <p style="margin:0">{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- ‚úÖ Le message est au-dessus du formulaire -->
    <form class="reservation-form" method="POST" action="{{ url_for('reservation', lang=get_locale()) }}" novalidate>

      <input type="hidden" name="ui_lang" value="{{ get_locale() }}">

      <label for="nom">{{ _("Nom") }}</label>
      <input type="text" id="nom" name="nom" required autocomplete="name" inputmode="text">

      <label for="email">{{ _("Email") }}</label>
      <input type="email" id="email" name="email" required autocomplete="email" inputmode="email">

      <!-- üìû T√©l√©phone -->
      <label for="phone_input">{{ _("T√©l√©phone (WhatsApp de pr√©f√©rence)") }}</label>
      <input type="tel" id="phone_input" inputmode="tel" autocomplete="tel" placeholder="{{ _('Ex. +33 6 12 34 56 78') }}" />
      <input type="hidden" name="phone" id="phone_full">

      <label for="country">{{ _("Pays") }}</label>
      <input type="text" id="country" name="country" placeholder="{{ _('France, Canada, Colombie...') }}" autocomplete="country-name" required>

      <label for="date">{{ _("Date souhait√©e") }}</label>
      <input type="date" id="date" name="date" required>

      <!-- üë• Nombre de personnes -->
      <label for="persons">{{ _("Nombre de personnes") }} <small aria-hidden="true">({{ _("max") }} 6)</small></label>
      <input type="number" id="persons" name="persons" min="1" max="6" value="1" required aria-describedby="persons-hint">
      <div id="persons-hint" class="sr-only">{{ _("Maximum 6 personnes") }}</div>

      <label for="message">{{ _("Message") }}</label>
      <textarea id="message" name="message" rows="4" placeholder="{{ _('Infos utiles, horaires, etc.') }}"></textarea>

      <label for="tour">{{ _("Choisissez un tour") }}</label>
      <select name="tour" id="tour" required>
        <option value="">{{ _("-- S√©lectionnez --") }}</option>
        <option value="candelaria" {{ 'selected' if tour=='candelaria' else '' }}>{{ _("Visite historique de La Candelaria") }}</option>
        <option value="monserrate" {{ 'selected' if tour=='monserrate' else '' }}>{{ _("D√©couverte du Monserrate") }}</option>
        <option value="zipaquira"  {{ 'selected' if tour=='zipaquira'  else '' }}>{{ _("Excursion √† la Cath√©drale de sel de Zipaquir√°") }}</option>
        <option value="chorrera"   {{ 'selected' if tour=='chorrera'   else '' }}>{{ _("Cascade de La Chorrera") }}</option>
        <option value="finca-cafe" {{ 'selected' if tour=='finca-cafe' else '' }}>{{ _("Visite d‚Äôune finca √† caf√©") }}</option>
      </select>

      <!-- üü° PayPal: champ cach√© pour l‚ÄôID de capture -->
      <input type="hidden" id="paypal_capture_id" name="paypal_capture_id" value="">

      <!-- Bouton Envoyer d√©sactiv√© tant que le paiement n'est pas confirm√© -->
      <button type="submit" id="form-submit" disabled>{{ _("Envoyer") }}</button>
    </form>

    <!-- üü° PayPal: bloc bouton -->
    <div class="payment-box" style="max-width:1000px;margin:24px auto;padding:16px;border:1px solid #e5e7eb;border-radius:12px;background:#fafafa">
      <h2 style="margin:0 0 12px 0;font-size:1.25rem">{{ _("Payer maintenant par PayPal") }}</h2>
      <div id="paypal-button-container"></div>
      <p style="margin-top:10px;font-size:.9rem;color:#374151">
        {{ _("Le paiement est s√©curis√© via PayPal. Le montant est calcul√© automatiquement selon le tour et le nombre de personnes.") }}
      </p>
    </div>
    <!-- /PayPal -->
  </section>
</main>


<!-- Donn√©es structur√©es -->
<script type="application/ld+json">{"@context":"https://schema.org","@type":"Service","name":"R√©servation de visites guid√©es √† Bogot√°"}</script>

<!-- ‚úÖ Script toggle du header -->
<script>
  (function(){
    const header = document.querySelector('.site-header');
    if(!header) return;
    function onScroll(){ header.classList.toggle('scrolled', window.scrollY > 60); }
    onScroll();
    window.addEventListener('scroll', onScroll, {passive:true});
  })();
</script>

<!-- üì± intl-tel-input JS -->
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/utils.js"></script>
<script>
  (function(){
    const input = document.getElementById('phone_input');
    if(!input) return;
    // Choix du pays par d√©faut selon la langue du site
    const lang = "{{ get_locale() }}";
    let initial = 'fr';
    if (lang === 'en') initial = 'us';
    if (lang === 'es') initial = 'co'; // Colombie sur ES

    const iti = window.intlTelInput(input, {
      initialCountry: initial,
      separateDialCode: true,
      utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/utils.js'
    });

    // √Ä l‚Äôenvoi: on stocke le num√©ro complet au format E.164 dans l‚Äôinput cach√© "phone"
    const form = document.querySelector('.reservation-form');
    form.addEventListener('submit', function(){
      const hidden = document.getElementById('phone_full');
      const e164 = iti.getNumber(); // ex: +33612345678
      hidden.value = e164 || input.value.trim();
    });
  })();
</script>

<!-- ===== PayPal: bloc complet (SDK + createOrder + onApprove robuste) ===== -->
<script>
  (async function(){
    // 1) R√©cup√®re la config serveur (client_id + currency)
    const cfgRes = await fetch("/paypal-config");
    if (!cfgRes.ok) { alert("Erreur /paypal-config"); return; }
    const cfg = await cfgRes.json();

    // 2) Charge le SDK PayPal (LIVE si PAYPAL_MODE=live)
    await new Promise((ok, ko) => {
      const s = document.createElement("script");
      s.src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(cfg.client_id)}&components=buttons&currency=${encodeURIComponent(cfg.currency)}`;
      s.onload = ok; s.onerror = () => ko(new Error("√âchec chargement SDK PayPal"));
      document.head.appendChild(s);
    });

    // 3) Rend les boutons
    paypal.Buttons({
      style: { shape: "rect", layout: "vertical" },

      // üëâ IMPORTANT : cr√©er la commande c√¥t√© serveur pour calculer le montant
      createOrder: async () => {
        const tour = (document.getElementById("tour")?.value || "").toLowerCase();
        const persons = parseInt(document.getElementById("persons")?.value || "1", 10);

        if (!tour) { alert("Merci de choisir un tour."); throw new Error("tour_required"); }

        const r = await fetch("/create-paypal-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tour, persons })
        });
        const data = await r.json();
        if (!r.ok) {
          const msg = (data && (data.error?.message || data.error || data.detail)) || "Erreur serveur";
          alert("‚ùå Cr√©ation de la commande PayPal impossible : " + msg);
          throw new Error(msg);
        }
        return data.id; // orderID
      },

      // ‚úÖ Ton onApprove robuste (serveur -> fallback client -> order.get)
      onApprove: async (data, actions) => {
        const setPaid = (capId) => {
          if (!capId) return false;
          document.getElementById('paypal_capture_id').value = capId;
          const submitBtn = document.getElementById('form-submit');
          if (submitBtn) submitBtn.disabled = false;
          return true;
        };

        // 1) Capture SERVEUR
        try {
          const r = await fetch(`/capture-paypal-order/${data.orderID}`, { method: 'POST' });
          const res = await r.json();

          if (r.ok && (res.status === "COMPLETED" || res.status === "APPROVED")) {
            let capId = res.id;
            try { if (!capId) capId = res.raw?.purchase_units?.[0]?.payments?.captures?.[0]?.id; } catch(e){}
            if (setPaid(capId)) { alert('‚úÖ Paiement confirm√© ! Vous pouvez envoyer votre r√©servation.'); return; }
          }
        } catch(e) { console.warn("capture serveur KO, fallback client", e); }

        // 2) Fallback: CAPTURE CLIENT
        try {
          const clientCap = await actions.order.capture();
          let capId = clientCap?.purchase_units?.[0]?.payments?.captures?.[0]?.id || clientCap?.id;
          if (setPaid(capId)) { alert('‚úÖ Paiement confirm√© (fallback). Vous pouvez envoyer votre r√©servation.'); return; }
        } catch(e) { console.warn("fallback capture client KO", e); }

        // 3) Dernier recours : lire l‚Äôordre
        try {
          const details = await actions.order.get();
          let capId = details?.purchase_units?.[0]?.payments?.captures?.[0]?.id || details?.id;
          if (setPaid(capId)) { alert('‚úÖ Paiement confirm√©. Vous pouvez envoyer votre r√©servation.'); return; }
        } catch(e) { console.warn("order.get KO", e); }

        alert("Paiement valid√© mais la confirmation n'a pas √©t√© re√ßue. Contactez-nous si besoin.");
      },

      onCancel: () => { alert("Paiement annul√©."); },
      onError:  (err) => { console.error(err); alert("Erreur PayPal : " + (err?.message || "inconnue")); }
    }).render('#paypal-button-container');
  })();
</script>

<!-- Garde-fou: emp√™che l'envoi si paiement non confirm√© -->
<script>
  (function(){
    const form = document.querySelector('.reservation-form');
    if(!form) return;
    form.addEventListener('submit', function(e){
      const paid = (document.getElementById('paypal_capture_id').value || '').trim().length > 0;
      if(!paid){
        e.preventDefault();
        alert("Merci d'effectuer le paiement PayPal avant d'envoyer la r√©servation.");
      }
    });
  })();
</script>
<!-- ===== /PayPal ===== -->


<!-- Garde-fou: emp√™che l'envoi si paiement non confirm√© -->
<script>
  (function(){
    const form = document.querySelector('.reservation-form');
    if(!form) return;
    form.addEventListener('submit', function(e){
      const paid = (document.getElementById('paypal_capture_id').value || '').trim().length > 0;
      if(!paid){
        e.preventDefault();
        alert("Merci d'effectuer le paiement PayPal avant d'envoyer la r√©servation.");
      }
    });
  })();
</script>
<!-- /PayPal -->

</body>
</html>


