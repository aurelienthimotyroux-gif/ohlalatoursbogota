<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
  <meta charset="UTF-8" />
  <title>{{ _("R√©server votre visite") }} ‚Äî Oh La La Tours Bogot√°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ Meta SEO -->
  <meta name="description" content="{{ _('R√©servez votre visite guid√©e √† Bogot√° : Candelaria, Monserrate, Zipaquir√°, La Chorrera et finca caf√©. Guide francophone/anglais/espagnol. Paiement PayPal s√©curis√©.') }}">
  <meta name="keywords" content="r√©servation tour Bogot√°, r√©server visite guid√©e Bogot√°, tours priv√©s Bogot√°, Candelaria, Monserrate, Zipaquir√°, La Chorrera, Hacienda Coloma, guide francophone Bogot√°, paiement PayPal Bogot√°">

  <!-- ‚úÖ CMP / consentmanager (doit √™tre avant GA) -->
  <script type="text/javascript" data-cmp-ab="0"
          src="https://cdn.consentmanager.net/delivery/autoblocking/62cc8437f29ac.js"
          data-cmp-host="b.delivery.consentmanager.net"
          data-cmp-cdn="cdn.consentmanager.net"
          data-cmp-codesrc="16"></script>

  <!-- ‚úÖ Google Consent Mode -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('consent', 'default', {
      ad_storage: 'denied',
      analytics_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied',
      wait_for_update: 500
    });
  </script>

  <!-- ‚úÖ Google tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-92M6CENDXH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-92M6CENDXH', { anonymize_ip: true });
  </script>

  <!-- ‚úÖ Texte masqu√© accessible -->
  <style>
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1px,1px);white-space:nowrap;border:0}
  </style>

  <!-- ‚úÖ Styles AJOUT√âS pour le header fixe + logo -->
  <style>
    .site-header{
      position:fixed; top:0; left:0; right:0; z-index:70;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; gap:16px;
      background:transparent; transition:background .25s ease, box-shadow .25s ease;
    }
    .brand{display:inline-flex; align-items:center; gap:10px}
    .logo{height:44px; width:auto; display:block}
    @media (max-width:640px){ .logo{height:32px} }

    .main-nav{display:flex; align-items:center; gap:18px; font-weight:600}
    .main-nav a{text-decoration:none}
    .lang-switcher{display:flex; gap:8px; margin-left:8px}
    .lang-switcher a{font-size:20px; line-height:1; padding:4px 6px; border-radius:6px}

    /* Sur cette page (hero en fond) : liens & logo blancs au d√©part */
    .header-on-hero .main-nav a{color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .logo--dark{display:none}

    /* ‚úÖ Titre ajout√© */
    .site-title{
      font-size:1.35rem;
      font-weight:600;
      margin-left:8px;
      line-height:1.2;
    }
    .header-on-hero .site-title{ color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35); }
    .site-header.scrolled .site-title{ color:#0f172a; text-shadow:none; }

    /* Au scroll / fond clair */
    .site-header.scrolled{
      background: rgba(255,255,255,.86);
      backdrop-filter: saturate(180%) blur(8px);
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .site-header.scrolled .logo--light{display:none}
    .site-header.scrolled .logo--dark{display:block}
    .site-header.scrolled .main-nav a{color:#0f172a}
  </style>

  <!-- ‚úÖ Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='img/favicon/site.webmanifest') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon/favicon.ico') }}">
  <link rel="icon" href="/favicon.ico" sizes="any">
  <meta name="theme-color" content="#0b4654">
  <meta name="google-site-verification" content="4z28-XXEkdcB_VOcaGoy1bhgA-zj7xr6wSf76ZwZ4tQ" />

  <!-- ‚úÖ Canonical + hreflang -->
  <link rel="canonical" href="https://www.ohlalatoursbogota.com{{ request.path }}{% if get_locale()!='fr' %}?lang={{ get_locale() }}{% endif %}">
  <link rel="alternate" href="{{ url_for('reservation', lang='fr', _external=True) }}" hreflang="fr">
  <link rel="alternate" href="{{ url_for('reservation', lang='en', _external=True) }}" hreflang="en">
  <link rel="alternate" href="{{ url_for('reservation', lang='es', _external=True) }}" hreflang="es">
  <link rel="alternate" href="{{ url_for('reservation', lang='fr', _external=True) }}" hreflang="x-default">

  <!-- ‚úÖ Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.ohlalatoursbogota.com{{ request.path }}{% if get_locale()!='fr' %}?lang={{ get_locale() }}{% endif %}">
  <meta property="og:site_name" content="Oh La La Tours Bogot√°">
  <meta property="og:title" content="{{ _('R√©server votre visite ‚Äì Oh La La Tours Bogot√°') }}">
  <meta property="og:description" content="{{ _('R√©servez une visite guid√©e : Candelaria, Monserrate, Zipaquir√°, La Chorrera ou finca caf√©. Paiement PayPal, guide francophone/anglais/espagnol.') }}">
  <meta property="og:image" content="{{ url_for('static', filename='images/bg_reservation.jpg', _external=True) }}">
  <meta property="og:image:alt" content="{{ _('Panorama de Bogot√°, t√©l√©ph√©rique de Monserrate et rues coloniales de la Candelaria...') }}">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _('R√©server votre visite ‚Äì Oh La La Tours Bogot√°') }}">
  <meta name="twitter:description" content="{{ _('R√©servez une visite guid√©e...') }}">
  <meta name="twitter:image" content="{{ url_for('static', filename='images/bg_reservation.jpg', _external=True) }}">
  <meta name="twitter:image:alt" content="{{ _('Panorama de Bogot√°, t√©l√©ph√©rique de Monserrate et rues coloniales de la Candelaria...') }}">

  <!-- ‚úÖ CSS global -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header class="site-header header-on-hero">
  <div class="logo-container">
    <!-- Logo clair -->
    <img src="{{ url_for('static', filename='img/logo-light.png') }}" alt="Oh La La Tours Bogot√°" class="logo logo--light">
    <!-- Logo fonc√© -->
    <img src="{{ url_for('static', filename='img/logo-dark.png') }}" alt="Oh La La Tours Bogot√°" class="logo logo--dark">
    <!-- ‚úÖ Titre ajout√© -->
    <span class="site-title">Oh La La Tours Bogot√°</span>
  </div>

  <nav class="main-nav" aria-label="{{ _('Navigation principale') }}">
    <a href="{{ url_for('index', lang=get_locale()) }}">{{ _("Accueil") }}</a>
    <a href="{{ url_for('tours', lang=get_locale()) }}">{{ _("Nos tours") }}</a>
    <a href="{{ url_for('transport', lang=get_locale()) }}">{{ _("Service de Transport") }}</a>
    <a href="{{ url_for('reservation', lang=get_locale()) }}">{{ _("R√©servation") }}</a>
    <div class="lang-switcher" aria-label="{{ _('Changer de langue') }}">
      <a href="{{ lang_url('fr') }}" lang="fr" aria-label="Fran√ßais">üá´üá∑<span class="sr-only">Fran√ßais</span></a>
      <a href="{{ lang_url('en') }}" lang="en" aria-label="English">üá∫üá∏<span class="sr-only">English</span></a>
      <a href="{{ lang_url('es') }}" lang="es" aria-label="Espa√±ol">üá™üá∏<span class="sr-only">Espa√±ol</span></a>
    </div>
  </nav>
</header>

<!-- Bandeau -->
<header class="hero background-half"
        style="background-image: url('{{ url_for('static', filename='images/bg_reservation.jpg') }}');">
  <h1 class="hero-title">
    {{ _("R√©server votre visite") }}{% if tour %} : {{ _(tour.capitalize()) }}{% endif %}
  </h1>
</header>

<!-- Fil d‚ÄôAriane -->
<nav aria-label="{{ _('Fil d‚ÄôAriane') }}" style="max-width:1000px;margin:10px auto;padding:0 20px;font-size:.95rem;">
  <a href="{{ url_for('index', lang=get_locale()) }}">{{ _('Accueil') }}</a> ‚Ä∫
  <a href="{{ url_for('tours', lang=get_locale()) }}">{{ _('Nos tours') }}</a> ‚Ä∫
  <span aria-current="page">{{ _('R√©servation') }}</span>
</nav>

<!-- Formulaire -->
<main>
  <section class="reservation-container">
    <form class="reservation-form" method="POST" action="{{ url_for('reservation', lang=get_locale()) }}" novalidate>
      {% if tour %}
        <input type="hidden" name="tour" value="{{ tour }}">
      {% endif %}

      <label for="nom">{{ _("Nom") }}</label>
      <input type="text" id="nom" name="nom" required autocomplete="name" inputmode="text">

      <label for="email">{{ _("Email") }}</label>
      <input type="email" id="email" name="email" required autocomplete="email" inputmode="email">

      <label for="date">{{ _("Date souhait√©e") }}</label>
      <input type="date" id="date" name="date" required>

      <label for="message">{{ _("Message") }}</label>
      <textarea id="message" name="message" rows="4" placeholder="{{ _('Infos utiles, horaires, etc.') }}"></textarea>

      <label for="tour">{{ _("Choisissez un tour") }}</label>
      <select name="tour" id="tour" required>
        <option value="">{{ _("-- S√©lectionnez --") }}</option>
        <option value="candelaria" {{ 'selected' if tour=='candelaria' else '' }}>{{ _("Visite historique de La Candelaria") }}</option>
        <option value="monserrate" {{ 'selected' if tour=='monserrate' else '' }}>{{ _("Randonn√©e √† Monserrate") }}</option>
        <option value="zipaquira"  {{ 'selected' if tour=='zipaquira'  else '' }}>{{ _("Excursion √† la Cath√©drale de sel de Zipaquir√°") }}</option>
        <option value="chorrera"   {{ 'selected' if tour=='chorrera'   else '' }}>{{ _("Cascade de La Chorrera") }}</option>
        <option value="finca-cafe" {{ 'selected' if tour=='finca-cafe' else '' }}>{{ _("Visite d‚Äôune finca √† caf√©") }}</option>
      </select>

      <label for="payment-method">{{ _("Mode de paiement") }}</label>
      <select id="payment-method" name="payment-method" aria-label="{{ _('Mode de paiement') }}">
        <option value="paypal" selected>PayPal</option>
      </select>

      <div id="paypal-section" style="margin-top:12px;">
        <label for="paypal-email">{{ _("Email PayPal") }}</label>
        <input type="email" id="paypal-email" name="paypal-email" placeholder="{{ _('optionnel') }}" autocomplete="email" inputmode="email">
        <small style="display:block;margin-top:6px;">
          {{ _("Pas de compte PayPal ? Choisissez l‚Äôoption carte bancaire sur l‚Äô√©cran PayPal.") }}
        </small>
        <div id="paypal-button-container" style="margin-top:12px;"></div>
        <div id="card-button-container" style="margin-top:12px;"></div>
        <div id="paypal-error" role="alert" style="display:none;margin-top:10px;padding:10px;border:1px solid #f00;color:#B00020;background:#FEE;"></div>
      </div>

      <button type="submit" id="form-submit">{{ _("Envoyer") }}</button>
    </form>
  </section>
</main>

<!-- PAYPAL (URL sur UNE ligne, rien d'autre chang√©) -->
<script src="https://www.paypal.com/sdk/js?client-id=AXcr1vyT3Zx-9XCo6fQLC94tyH4qoqxNAu-V8vVRMtm4kphjbOupFByJl6cAyyppQmE-YiOU7IaLOzuj&currency=USD&intent=CAPTURE&components=buttons&enable-funding=card,credit,paylater&locale={% if get_locale()=='fr' %}fr_FR{% elif get_locale()=='en' %}en_US{% else %}es_ES{% endif %}">
</script>

<!-- ‚úÖ DIAG PayPal -->
<div id="paypal-diagnostics" style="font:14px/1.4 system-ui; margin:12px 0; display:none; border:1px dashed #999; padding:8px; background:#fafafa"></div>
<script>
  (function(){
    const box = document.getElementById('paypal-diagnostics');
    function showDiag(msg){
      try { box.style.display = 'block'; box.innerHTML += '<div>'+msg+'</div>'; } catch(e){}
    }
    if (!window.paypal) {
      showDiag("‚ö†Ô∏è SDK PayPal non charg√©. V√©rifie Client ID, bloqueurs, CMP.");
    } else {
      showDiag("‚úÖ SDK PayPal charg√©: " + Object.keys(window.paypal).join(', '));
    }
    window.addEventListener('unhandledrejection', e => {
      showDiag("‚ùå Promise error: " + (e.reason && (e.reason.message || JSON.stringify(e.reason))));
    });
  })();
</script>

<!-- ‚úÖ AJOUT : helpers de mapping titres + prix -->
<script>
  function tourTitleFromSlug(slug) {
    const m = {
      'candelaria': "{{ _('Visite historique de La Candelaria') }}",
      'monserrate': "{{ _('Randonn√©e √† Monserrate') }}",
      'zipaquira':  "{{ _('Excursion √† la Cath√©drale de sel de Zipaquir√°') }}",
      'chorrera':   "{{ _('Cascade de La Chorrera') }}",
      'finca-cafe': "{{ _('Visite d‚Äôune finca √† caf√©') }}"
    };
    return m[slug] || slug || '';
  }
</script>

<!-- Int√©gration PayPal : version server-side orders -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const prices = { candelaria: 1, monserrate: 1, zipaquira: 1, chorrera: 1, 'finca-cafe': 50 };
    const form = document.querySelector('.reservation-form');
    const methodSelect = document.getElementById('payment-method');

    form.addEventListener('submit', function (e) {
      if (methodSelect.value === 'paypal') {
        e.preventDefault();
        document.getElementById('paypal-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        alert("{{ _('Pour payer avec PayPal, cliquez sur le bouton PayPal au-dessus de ¬´ Envoyer ¬ª.') }}");
      }
    });

    let paypalRendered = false;

    function renderPaypalButtons() {
      if (paypalRendered) return;
      const errBox = document.getElementById('paypal-error');
      const diag = document.getElementById('paypal-diagnostics');

      function showError(msg, err) {
        errBox.style.display = 'block';
        errBox.textContent = (msg || 'PayPal error') + (err ? ' ‚Üí ' + (err.message || (err.debug_id ? ('debug_id='+err.debug_id) : JSON.stringify(err))) : '');
        if (diag) { diag.style.display = 'block'; diag.innerHTML += '<div>‚ùå ' + errBox.textContent + '</div>'; }
        console.error('[PayPal]', msg, err);
      }

      if (!window.paypal || !window.paypal.Buttons) {
        showError("SDK PayPal non disponible");
        return;
      }

      const btn = paypal.Buttons({
        fundingSource: paypal.FUNDING.PAYPAL,
        style: { layout: 'vertical', shape: 'rect' },

        // üëâ createOrder via ton backend
        createOrder: function (data, actions) {
          const tourId = document.getElementById('tour').value || '';
          if (!tourId) {
            showError("Aucun tour s√©lectionn√©");
            throw new Error("Aucun tour s√©lectionn√©");
          }
          return fetch('/api/paypal/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tour: tourId })
          })
          .then(res => res.json())
          .then(j => {
            if (!j || !j.id) {
              showError("create-order a renvoy√© une r√©ponse invalide", j);
              throw new Error('R√©ponse invalide');
            }
            return j.id;
          })
          .catch(err => { showError("create-order a √©chou√©", err); throw err; });
        },

        // üëâ capture via ton backend (plus robuste que actions.order.capture)
        onApprove: function (data, actions) {
          const orderID = data.orderID;
          return fetch('/api/paypal/capture-order/' + encodeURIComponent(orderID), {
            method: 'POST'
          })
          .then(res => res.json())
          .then(async (details) => {
            try {
              const purchase = details && details.purchase_units && details.purchase_units[0];
              const capture  = purchase && purchase.payments && purchase.payments.captures && purchase.payments.captures[0];
              const captureID = capture ? capture.id : null;
              const amountVal = capture ? capture.amount.value : null;
              const currency  = capture ? capture.amount.currency_code : 'USD';
              const status    = details && details.status ? details.status : (capture ? capture.status : 'COMPLETED');

              const nom       = document.getElementById('nom').value.trim();
              const email     = document.getElementById('email').value.trim();
              const date      = document.getElementById('date').value;
              const message   = document.getElementById('message').value.trim();
              const tourSlug  = document.getElementById('tour').value || '';
              const tourTitle = tourTitleFromSlug(tourSlug);
              const pax       = 1;
              const lang      = "{{ get_locale() }}";

              // Notif interne backend (cr√©ation r√©servation + emails si tu ajoutes la logique)
              await fetch('/paypal/success', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  order_id: orderID,
                  capture_id: captureID,
                  status: status,
                  amount: amountVal,
                  currency: currency,
                  lang: lang,
                  reservation: {
                    fullname: nom,
                    email: email,
                    date: date,
                    message: message,
                    pax: pax,
                    tour_slug: tourSlug,
                    tour_title: tourTitle
                  }
                })
              }).catch(() => { /* on ignore: webhook/retour suffisent */ });

            } finally {
              // Redirection (inchang√©e)
              window.location.href = '/paiement-reussi?orderID=' + orderID + '&lang={{ get_locale() }}';
            }
          })
          .catch(err => { showError("capture-order a √©chou√©", err); throw err; });
        },

        onCancel: function () {
          window.location.href = '/paiement-annule?lang={{ get_locale() }}';
        },

        onError: function (err) {
          showError("onError()", err);
        }
      });

      if (!btn.isEligible()) {
        showError("Bouton PayPal non √©ligible pour ce navigateur / configuration.");
        return;
      }
      btn.render('#paypal-button-container').catch(function (err) {
        showError("render() a √©chou√©", err);
      });

      // Bouton carte (si autoris√© par PayPal)
      const cardBtn = paypal.Buttons({ fundingSource: paypal.FUNDING.CARD });
      if (cardBtn && cardBtn.isEligible()) { cardBtn.render('#card-button-container'); }

      paypalRendered = true;
    }

    renderPaypalButtons();
  });
</script>

<!-- Donn√©es structur√©es -->
<script type="application/ld+json">{"@context":"https://schema.org","@type":"Service","name":"R√©servation de visites guid√©es √† Bogot√°"}</script>

<!-- ‚úÖ Script toggle du header -->
<script>
  (function(){
    const header = document.querySelector('.site-header');
    if(!header) return;
    function onScroll(){ header.classList.toggle('scrolled', window.scrollY > 60); }
    onScroll();
    window.addEventListener('scroll', onScroll, {passive:true});
  })();
</script>

</body>
</html>
