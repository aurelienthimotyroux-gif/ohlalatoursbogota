<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
  <meta charset="UTF-8" />
  <title>{{ _("RÃ©server votre visite") }} â€” Oh La La Tours BogotÃ¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- âœ… Meta SEO -->
  <meta name="description" content="{{ _('RÃ©servez votre visite guidÃ©e Ã  BogotÃ¡ : Candelaria, Monserrate, ZipaquirÃ¡, La Chorrera et finca cafÃ©. Guide francophone/anglais/espagnol. Paiement PayPal sÃ©curisÃ©.') }}">
  <meta name="keywords" content="rÃ©servation tour BogotÃ¡, rÃ©server visite guidÃ©e BogotÃ¡, tours privÃ©s BogotÃ¡, Candelaria, Monserrate, ZipaquirÃ¡, La Chorrera, Hacienda Coloma, guide francophone BogotÃ¡, paiement PayPal BogotÃ¡">

  <!-- âœ… CMP / consentmanager (doit Ãªtre avant GA) -->
  <script type="text/javascript" data-cmp-ab="1"
          src="https://cdn.consentmanager.net/delivery/autoblocking/62cc8437f29ac.js"
          data-cmp-host="b.delivery.consentmanager.net"
          data-cmp-cdn="cdn.consentmanager.net"
          data-cmp-codesrc="16"></script>

  <!-- âœ… Google Consent Mode -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('consent', 'default', {
      ad_storage: 'denied',
      analytics_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied',
      wait_for_update: 500
    });
  </script>

  <!-- âœ… Google tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-92M6CENDXH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-92M6CENDXH', { anonymize_ip: true });
  </script>

  <!-- âœ… Texte masquÃ© accessible -->
  <style>
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1px,1px);white-space:nowrap;border:0}
  </style>

  <!-- âœ… Styles AJOUTÃ‰S pour le header fixe + logo -->
  <style>
    .site-header{
      position:fixed; top:0; left:0; right:0; z-index:70;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; gap:16px;
      background:transparent; transition:background .25s ease, box-shadow .25s ease;
    }
    .brand{display:inline-flex; align-items:center; gap:10px}
    .logo{height:44px; width:auto; display:block}
    @media (max-width:640px){ .logo{height:32px} }

    .main-nav{display:flex; align-items:center; gap:18px; font-weight:600}
    .main-nav a{text-decoration:none}
    .lang-switcher{display:flex; gap:8px; margin-left:8px}
    .lang-switcher a{font-size:20px; line-height:1; padding:4px 6px; border-radius:6px}

    /* Sur cette page (hero en fond) : liens & logo blancs au dÃ©part */
    .header-on-hero .main-nav a{color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .logo--dark{display:none}

    /* âœ… Titre ajoutÃ© */
    .site-title{
      font-size:1.35rem;
      font-weight:600;
      margin-left:8px;
      line-height:1.2;
    }
    .header-on-hero .site-title{ color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35); }
    .site-header.scrolled .site-title{ color:#0f172a; text-shadow:none; }

    /* Au scroll / fond clair */
    .site-header.scrolled{
      background: rgba(255,255,255,.86);
      backdrop-filter: saturate(180%) blur(8px);
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .site-header.scrolled .logo--light{display:none}
    .site-header.scrolled .logo--dark{display:block}
    .site-header.scrolled .main-nav a{color:#0f172a}
  </style>

  <!-- âœ… Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/favicon/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/favicon/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='img/favicon/site.webmanifest') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon/favicon.ico') }}">
  <link rel="icon" href="/favicon.ico" sizes="any">
  <meta name="theme-color" content="#0b4654">
  <meta name="google-site-verification" content="4z28-XXEkdcB_VOcaGoy1bhgA-zj7xr6wSf76ZwZ4tQ" />

  <!-- âœ… Canonical + hreflang -->
  <link rel="canonical" href="https://www.ohlalatoursbogota.com{{ request.path }}{% if get_locale()!='fr' %}?lang={{ get_locale() }}{% endif %}">
  <link rel="alternate" href="{{ url_for('reservation', lang='fr', _external=True) }}" hreflang="fr">
  <link rel="alternate" href="{{ url_for('reservation', lang='en', _external=True) }}" hreflang="en">
  <link rel="alternate" href="{{ url_for('reservation', lang='es', _external=True) }}" hreflang="es">
  <link rel="alternate" href="{{ url_for('reservation', lang='fr', _external=True) }}" hreflang="x-default">

  <!-- âœ… Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.ohlalatoursbogota.com{{ request.path }}{% if get_locale()!='fr' %}?lang={{ get_locale() }}{% endif %}">
  <meta property="og:site_name" content="Oh La La Tours BogotÃ¡">
  <meta property="og:title" content="{{ _('RÃ©server votre visite â€“ Oh La La Tours BogotÃ¡') }}">
  <meta property="og:description" content="{{ _('RÃ©servez une visite guidÃ©e : Candelaria, Monserrate, ZipaquirÃ¡, La Chorrera ou finca cafÃ©. Paiement PayPal, guide francophone/anglais/espagnol.') }}">
  <meta property="og:image" content="{{ url_for('static', filename='images/bg_reservation.jpg', _external=True) }}">
  <meta property="og:image:alt" content="{{ _('Panorama de BogotÃ¡, tÃ©lÃ©phÃ©rique de Monserrate et rues coloniales de la Candelaria...') }}">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ _('RÃ©server votre visite â€“ Oh La La Tours BogotÃ¡') }}">
  <meta name="twitter:description" content="{{ _('RÃ©servez une visite guidÃ©e...') }}">
  <meta name="twitter:image" content="{{ url_for('static', filename='images/bg_reservation.jpg', _external=True) }}">
  <meta name="twitter:image:alt" content="{{ _('Panorama de BogotÃ¡, tÃ©lÃ©phÃ©rique de Monserrate et rues coloniales de la Candelaria...') }}">

  <!-- âœ… CSS global -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header class="site-header header-on-hero">
  <div class="logo-container">
    <!-- Logo clair -->
    <img src="{{ url_for('static', filename='img/logo-light.png') }}" alt="Oh La La Tours BogotÃ¡" class="logo logo--light">
    <!-- Logo foncÃ© -->
    <img src="{{ url_for('static', filename='img/logo-dark.png') }}" alt="Oh La La Tours BogotÃ¡" class="logo logo--dark">
    <!-- âœ… Titre ajoutÃ© -->
    <span class="site-title">Oh La La Tours BogotÃ¡</span>
  </div>

  <nav class="main-nav" aria-label="{{ _('Navigation principale') }}">
    <a href="{{ url_for('index', lang=get_locale()) }}">{{ _("Accueil") }}</a>
    <a href="{{ url_for('tours', lang=get_locale()) }}">{{ _("Nos tours") }}</a>
    <a href="{{ url_for('transport', lang=get_locale()) }}">{{ _("Service de Transport") }}</a>
    <a href="{{ url_for('reservation', lang=get_locale()) }}">{{ _("RÃ©servation") }}</a>
    <div class="lang-switcher" aria-label="{{ _('Changer de langue') }}">
      <a href="{{ lang_url('fr') }}" lang="fr" aria-label="FranÃ§ais">ðŸ‡«ðŸ‡·<span class="sr-only">FranÃ§ais</span></a>
      <a href="{{ lang_url('en') }}" lang="en" aria-label="English">ðŸ‡ºðŸ‡¸<span class="sr-only">English</span></a>
      <a href="{{ lang_url('es') }}" lang="es" aria-label="EspaÃ±ol">ðŸ‡ªðŸ‡¸<span class="sr-only">EspaÃ±ol</span></a>
    </div>
  </nav>
</header>

<!-- Bandeau -->
<header class="hero background-half"
        style="background-image: url('{{ url_for('static', filename='images/bg_reservation.jpg') }}');">
  <h1 class="hero-title">
    {{ _("RÃ©server votre visite") }}{% if tour %} : {{ _(tour.capitalize()) }}{% endif %}
  </h1>
</header>

<!-- Fil dâ€™Ariane -->
<nav aria-label="{{ _('Fil dâ€™Ariane') }}" style="max-width:1000px;margin:10px auto;padding:0 20px;font-size:.95rem;">
  <a href="{{ url_for('index', lang=get_locale()) }}">{{ _('Accueil') }}</a> â€º
  <a href="{{ url_for('tours', lang=get_locale()) }}">{{ _('Nos tours') }}</a> â€º
  <span aria-current="page">{{ _('RÃ©servation') }}</span>
</nav>

<!-- Formulaire -->
<main>
  <section class="reservation-container">
    <form class="reservation-form" method="POST" action="{{ url_for('reservation', lang=get_locale()) }}" novalidate>
      {% if tour %}
        <input type="hidden" name="tour" value="{{ tour }}">
      {% endif %}

      <label for="nom">{{ _("Nom") }}</label>
      <input type="text" id="nom" name="nom" required autocomplete="name" inputmode="text">

      <label for="email">{{ _("Email") }}</label>
      <input type="email" id="email" name="email" required autocomplete="email" inputmode="email">

      <label for="date">{{ _("Date souhaitÃ©e") }}</label>
      <input type="date" id="date" name="date" required>

      <label for="message">{{ _("Message") }}</label>
      <textarea id="message" name="message" rows="4" placeholder="{{ _('Infos utiles, horaires, etc.') }}"></textarea>

      <label for="tour">{{ _("Choisissez un tour") }}</label>
      <select name="tour" id="tour" required>
        <option value="">{{ _("-- SÃ©lectionnez --") }}</option>
        <option value="candelaria" {{ 'selected' if tour=='candelaria' else '' }}>{{ _("Visite historique de La Candelaria") }}</option>
        <option value="monserrate" {{ 'selected' if tour=='monserrate' else '' }}>{{ _("RandonnÃ©e Ã  Monserrate") }}</option>
        <option value="zipaquira"  {{ 'selected' if tour=='zipaquira'  else '' }}>{{ _("Excursion Ã  la CathÃ©drale de sel de ZipaquirÃ¡") }}</option>
        <option value="chorrera"   {{ 'selected' if tour=='chorrera'   else '' }}>{{ _("Cascade de La Chorrera") }}</option>
        <option value="finca-cafe" {{ 'selected' if tour=='finca-cafe' else '' }}>{{ _("Visite dâ€™une finca Ã  cafÃ©") }}</option>
      </select>

      <label for="payment-method">{{ _("Mode de paiement") }}</label>
      <select id="payment-method" name="payment-method" aria-label="{{ _('Mode de paiement') }}">
        <option value="paypal" selected>PayPal</option>
      </select>

      <div id="paypal-section" style="margin-top:12px;">
        <label for="paypal-email">{{ _("Email PayPal") }}</label>
        <input type="email" id="paypal-email" name="paypal-email" placeholder="{{ _('optionnel') }}" autocomplete="email" inputmode="email">
        <small style="display:block;margin-top:6px;">
          {{ _("Pas de compte PayPal ? Choisissez lâ€™option carte bancaire sur lâ€™Ã©cran PayPal.") }}
        </small>
        <div id="paypal-button-container" style="margin-top:12px;"></div>
        <div id="card-button-container" style="margin-top:12px;"></div>
        <div id="paypal-error" role="alert" style="display:none;margin-top:10px;padding:10px;border:1px solid #f00;color:#B00020;background:#FEE;"></div>
      </div>

      <button type="submit" id="form-submit">{{ _("Envoyer") }}</button>
    </form>
  </section>
</main>

<!-- PAYPAL SDK (live / USD) -->
<script src="https://www.paypal.com/sdk/js?client-id=AXcr1vyT3Zx-9XCo6fQLC94tyH4qoqxNAu-V8vVRMtm4kphjbOupFByJl6cAyyppQmE-YiOU7IaLOzuj&currency=USD&intent=CAPTURE&components=buttons&enable-funding=card,credit,paylater&locale={% if get_locale()=='fr' %}fr_FR{% elif get_locale()=='en' %}en_US{% else %}es_ES{% endif %}"></script>

<!-- IntÃ©gration PayPal (create/capture cÃ´tÃ© serveur) -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const prices = { candelaria: 1, monserrate: 1, zipaquira: 1, chorrera: 1, 'finca-cafe': 50 };
    const form = document.querySelector('.reservation-form');
    const methodSelect = document.getElementById('payment-method');

    form.addEventListener('submit', function (e) {
      if (methodSelect.value === 'paypal') {
        e.preventDefault();
        document.getElementById('paypal-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        alert("{{ _('Pour payer avec PayPal, cliquez sur le bouton PayPal au-dessus de Â« Envoyer Â».') }}");
      }
    });

    let paypalRendered = false;
    function renderPaypalButtons() {
      if (paypalRendered) return;

      const errBox = document.getElementById('paypal-error');
      if (!window.paypal) {
        errBox.style.display = 'block';
        errBox.textContent = "{{ _('PayPal ne sâ€™est pas chargÃ©. VÃ©rifiez votre Client ID et dÃ©sactivez les bloqueurs.') }}";
        return;
      }

      paypal.Buttons({
        fundingSource: paypal.FUNDING.PAYPAL,

        // --- CREATE ORDER (server-side) ---
        createOrder: async function () {
          try {
            const tourId = document.getElementById('tour').value || '';
            const amount = (prices[tourId] || 40).toFixed(2);

            const res = await fetch("/api/paypal/create-order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ amount, tour: tourId })
            });

            if (!res.ok) {
              const txt = await res.text();
              throw new Error("create-order HTTP " + res.status + " " + txt);
            }

            const order = await res.json();
            return order.id; // orderID crÃ©Ã© cÃ´tÃ© serveur
          } catch (e) {
            errBox.style.display = 'block';
            errBox.textContent = "PayPal (createOrder): " + e.message;
            throw e;
          }
        },

        // --- CAPTURE (server-side) ---
        onApprove: async function (data) {
          try {
            const res = await fetch("/api/paypal/capture-order/" + data.orderID, { method: "POST" });

            if (!res.ok) {
              const txt = await res.text();
              throw new Error("capture-order HTTP " + res.status + " " + txt);
            }

            const capture = await res.json();

            // succÃ¨s
            if (capture.status === "COMPLETED" || (capture.purchase_units && capture.purchase_units[0]?.payments?.captures?.[0]?.status === "COMPLETED")) {
              window.location.href = '/paiement-reussi?orderID=' + data.orderID + '&lang={{ get_locale() }}';
              return;
            }

            // sinon, message utile
            const debugId = capture.debug_id || (capture.details && capture.details[0]?.issue) || "";
            throw new Error("Paiement non complÃ©tÃ© (" + (capture.status || "unknown") + ") " + (debugId ? "debug_id=" + debugId : ""));
          } catch (e) {
            const msg = "PayPal (capture): " + e.message;
            console.error(msg);
            const errBox = document.getElementById('paypal-error');
            errBox.style.display = 'block';
            errBox.textContent = msg;
          }
        },

        onCancel: function () { window.location.href = '/paiement-annule?lang={{ get_locale() }}'; },
        onError: function (err) {
          const errBox = document.getElementById('paypal-error');
          errBox.style.display = 'block';
          errBox.textContent = 'PayPal: ' + (err && err.message ? err.message : err);
        }
      }).render('#paypal-button-container');

      // Bouton "Carte" (redirigÃ© via PayPal) si dispo
      const cardBtn = paypal.Buttons({ fundingSource: paypal.FUNDING.CARD });
      if (cardBtn.isEligible()) { cardBtn.render('#card-button-container'); }

      paypalRendered = true;
    }

    renderPaypalButtons();
  });
</script>

<!-- DonnÃ©es structurÃ©es -->
<script type="application/ld+json">{"@context":"https://schema.org","@type":"Service","name":"RÃ©servation de visites guidÃ©es Ã  BogotÃ¡"}</script>

<!-- âœ… Script toggle du header -->
<script>
  (function(){
    const header = document.querySelector('.site-header');
    if(!header) return;
    function onScroll(){ header.classList.toggle('scrolled', window.scrollY > 60); }
    onScroll();
    window.addEventListener('scroll', onScroll, {passive:true});
  })();
</script>

</body>
</html>

